services:
  gluetun:
    image: qmcgaw/gluetun:latest
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    networks:
      - proxy
    volumes:
      - /home/tim/stacks/apps/qbittorrentvpn/gluetun:/gluetun:rw
    environment:
      - VPN_SERVICE_PROVIDER=private internet access
      - VPN_TYPE=openvpn
      - OPENVPN_USER=${OPENVPN_USER:?set in shared/.env.secrets}
      - OPENVPN_PASSWORD=${OPENVPN_PASSWORD:?set in shared/.env.secrets}
      - PORT_FORWARDING=on
      - PORT_FORWARDING_STATUS_FILE=/gluetun/forwarded_port
      - FIREWALL=on
      - TZ=Europe/Berlin
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.qbittorrent.rule=Host(`qbittorrent.${LAN_DOMAIN}`)
      - traefik.http.routers.qbittorrent.entrypoints=web
      - traefik.http.routers.qbittorrent.service=qbittorrent
      - traefik.http.services.qbittorrent.loadbalancer.server.port=8080

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    restart: unless-stopped
    network_mode: "service:gluetun"
    depends_on:
      - gluetun
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=Europe/Berlin
      - WEBUI_PORT=8080
        #- TORRENTING_PORT=6881
    volumes:
      - /home/tim/stacks/apps/qbittorrentvpn/qbittorrent:/config:rw
      - /mnt/d/Torrent:/downloads:rw

  port-sync:
    image: docker:27-cli
    restart: unless-stopped
    volumes:
      - /home/tim/stacks/apps/qbittorrentvpn/qbittorrent:/config:rw
      - /home/tim/stacks/apps/qbittorrentvpn/gluetun:/gluetun:ro
      - /home/tim/stacks/apps/qbittorrentvpn/scripts:/scripts:ro
      - /var/run/docker.sock:/var/run/docker.sock:rw
    environment:
      - TARGET_CONTAINER=qbittorrentvpn-qbittorrent-1
    command: ["/bin/sh", "/scripts/sync-port.sh"]

networks:
  proxy:
    external: true

