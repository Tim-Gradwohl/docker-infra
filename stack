#!/usr/bin/env bash
set -euo pipefail

ROOT="/home/tim/stacks"
ENV_GLOBAL="${ROOT}/shared/.env.global"
ENV_SECRETS="${ROOT}/shared/.env.secrets"

# Stacks (compose files)
declare -A STACKS
STACKS[gateway]="${ROOT}/gateway/compose.yml"
STACKS[adguardhome]="${ROOT}/apps/adguardhome/compose.yml"
STACKS[gitea]="${ROOT}/apps/gitea/compose.yml"
STACKS[immich]="${ROOT}/apps/immich/compose.yml"
STACKS[metube]="${ROOT}/apps/metube/compose.yml"
STACKS[iptvnator]="${ROOT}/apps/iptvnator/compose.yml"
STACKS[ytptube]="${ROOT}/apps/ytptube/compose.yml"
STACKS[qbittorrentvpn]="${ROOT}/apps/qbittorrentvpn/compose.yml"

# Which stacks require secrets at deploy-time (for interpolation + fail-fast guards)
REQUIRES_SECRETS_REGEX='^(gateway|immich|qbittorrentvpn)$'

usage() {
  cat <<USAGE
Usage:
  ./stack <cmd> <stack|all> [compose_args...]

Commands:
  config     Validate/print resolved compose
  up         Deploy (up -d by default)
  down       Stop/remove stack
  pull       Pull images
  restart    Restart services
  logs       Follow logs
  ps         Show containers

Examples:
  ./stack config gateway
  ./stack up gateway
  ./stack up immich --remove-orphans
  ./stack pull all
  ./stack logs gateway traefik
  ./stack down metube

Notes:
- Always uses: ${ENV_GLOBAL}
- Uses secrets for stacks matching: ${REQUIRES_SECRETS_REGEX} -> ${ENV_SECRETS}
- Ensure bcrypt hashes in .env.secrets escape \$ as \$\$
USAGE
}

need_files() {
  local s="$1"

  if [[ ! -f "${ENV_GLOBAL}" ]]; then
    echo "ERROR: Missing ${ENV_GLOBAL}" >&2
    exit 1
  fi

  if [[ "${s}" =~ ${REQUIRES_SECRETS_REGEX} ]] && [[ ! -f "${ENV_SECRETS}" ]]; then
    echo "ERROR: Missing ${ENV_SECRETS} (required for stack: ${s})" >&2
    exit 1
  fi

  if [[ -z "${STACKS[$s]:-}" ]]; then
    echo "ERROR: Unknown stack '${s}'" >&2
    echo "Known stacks: ${!STACKS[*]} all" >&2
    exit 1
  fi

  if [[ ! -f "${STACKS[$s]}" ]]; then
    echo "ERROR: Missing compose file for stack '${s}': ${STACKS[$s]}" >&2
    exit 1
  fi
}

compose() {
  local stack="$1"
  shift

  local args=(docker compose
    --project-name "${stack}"
    --project-directory "${ROOT}"
    --env-file "${ENV_GLOBAL}"
  )

  if [[ "${stack}" =~ ${REQUIRES_SECRETS_REGEX} ]]; then
    args+=(--env-file "${ENV_SECRETS}")
  fi

  args+=(-f "${STACKS[$stack]}")
  args+=("$@")

  "${args[@]}"
}

cmd="${1:-}"
stack="${2:-}"

if [[ -z "${cmd}" || -z "${stack}" ]]; then
  usage
  exit 1
fi

if [[ "${cmd}" == "-h" || "${cmd}" == "--help" ]]; then
  usage
  exit 0
fi

run_one() {
  local s="$1"
  shift
  need_files "${s}"

  case "${cmd}" in
    config)  compose "${s}" config ;;
    up)      compose "${s}" up -d "$@" ;;
    down)    compose "${s}" down "$@" ;;
    pull)    compose "${s}" pull "$@" ;;
    restart) compose "${s}" restart "$@" ;;
    logs)    compose "${s}" logs -f "$@" ;;
    ps)      compose "${s}" ps "$@" ;;
    *)
      echo "ERROR: Unknown command '${cmd}'" >&2
      usage
      exit 1
      ;;
  esac
}

if [[ "${stack}" == "all" ]]; then
  # Reasonable order: gateway first (routing), then services
  order=(gateway gitea adguardhome immich metube iptvnator ytptube qbittorrentvpn)

  # Forward only extra args AFTER "<cmd> all"
  extra_args=("${@:3}")

  for s in "${order[@]}"; do
    echo "==> ${cmd} ${s}"
    need_files "${s}"

    case "${cmd}" in
      config)  compose "${s}" config ;;
      up)      compose "${s}" up -d "${extra_args[@]}" ;;
      down)    compose "${s}" down "${extra_args[@]}" ;;
      pull)    compose "${s}" pull "${extra_args[@]}" ;;
      restart) compose "${s}" restart "${extra_args[@]}" ;;
      logs)    compose "${s}" logs -f "${extra_args[@]}" ;;
      ps)      compose "${s}" ps "${extra_args[@]}" ;;
      *)
        echo "ERROR: Unknown command '${cmd}'" >&2
        usage
        exit 1
        ;;
    esac
  done
else
  # IMPORTANT: only pass compose args after "<cmd> <stack>"
  need_files "${stack}"
  run_one "${stack}" "${@:3}"
fi

